---
- name: Converge
  hosts: all
  become: true

  vars:
    sentry_db_name: 'sentry'
    sentry_db_user: 'sentry'
    sentry_secret_key: 'SAFE'
    postgres_repo_version: '9.5'
    postgresql_databases:
      - name: '{{ sentry_db_name }}'
    postgresql_users:
      - name: '{{ sentry_db_user }}'
        db: '{{ sentry_db_name }}'
        role_attr_flags: SUPERUSER
    postgresql_hba_entries:
      - {type: local, database: all, user: postgres, auth_method: peer}
      - {type: local, database: '{{ sentry_db_name }}', user: '{{ sentry_db_user }}', auth_method: trust}

  pre_tasks:
    - name: Enable EPEL repo on EL for Redis role
      yum: pkg=epel-release state=present
      when: ansible_os_family == 'RedHat'
    - name: Install cron (RedHat).
      yum: name=cronie state=present
      when: ansible_os_family == 'RedHat'

  roles:
    - role: geerlingguy.redis
    - role: Duologic.postgresql_repository
    - role: geerlingguy.postgresql
    - role: Duologic.sentry

  post_tasks:
    - name: Check if Sentry is running.
      uri:
        url: "http://127.0.0.1:9000/"
